(window.webpackJsonp=window.webpackJsonp||[]).push([[33],{364:function(t,s,n){"use strict";n.r(s);var a=n(0),e=Object(a.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("p",[t._v("关于 ServiceWorker 大家也许或多或少都有听过一些关于他的东西，今天我们从以下四个方面来聊聊关于 ServiceWorker 的那些事。")]),t._v(" "),n("ul",[n("li",[t._v("什么是 ServiceWorker")]),t._v(" "),n("li",[t._v("ServiceWorker 能够做什么")]),t._v(" "),n("li",[t._v("ServiceWorker 最佳实践")])]),t._v(" "),n("h2",{attrs:{id:"web-worker"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#web-worker"}},[t._v("#")]),t._v(" Web Worker")]),t._v(" "),n("p",[t._v("首先在说什么是 ServiceWorker 之前我们先来看看什么是 Web Worker。")]),t._v(" "),n("p",[t._v("我们都知道 js 是单线程的运行机制，也就是说，所有任务只能在一个线程上完成，一次只能做一件事。只要前面的任务没做完，后面的任务就只能等着。比如我要洗衣服和做饭，js 的单线程模型就限制了我只能先洗完衣服才能做饭。而 Web Worker 允许在主线程之外再创建一个 Worker 线程，在主线程（一般是负责 UI 交互的部分，比如用户点击按钮，提交表单的操作）执行任务的同时，worker 线程也可以在后台执行它自己的任务，互不干扰。也就是我们现在可以先把衣服放进洗衣机，然后衣服在洗的同时，我还可以炒个菜什么的了。")]),t._v(" "),n("p",[t._v("有了 Web Worker 就能让 JS 变成多线程的环境了，我们可以把高延迟、花费大量时间的运算，分给 Worker 线程，最后再把结果返回给主线程就可以了，因为时间花费多的任务被 Web Worker 承担了，主线程就会很流畅了。")]),t._v(" "),n("p",[t._v("看个例子：")]),t._v(" "),n("p",[t._v("index.html")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("DOCTYPE")]),t._v(" html"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("html lang"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"en"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("head"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("meta charset"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"UTF-8"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("meta http"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("equiv"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"X-UA-Compatible"')]),t._v(" content"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"IE=edge"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("meta name"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"viewport"')]),t._v(" content"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"width=device-width, initial-scale=1.0"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("title"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("Document"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("title"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("head"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("body"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n  webWorker\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("body"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("script"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//  没有使用 web worker")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// console.time('没有使用 worker 主线程运行总时间')")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// console.time('洗衣服时间')")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// for (let index = 0; index < 100; index++) {")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//   console.log('我正在洗衣服')")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// }")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// console.timeEnd('洗衣服时间')")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// console.time('做饭时间')")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// for (let index = 0; index < 100; index++) {")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//   console.log('我正在做饭')")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// }")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// console.timeEnd('做饭时间')")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// console.timeEnd('没有使用 worker 主线程运行总时间')")]),t._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 使用 Web worker")]),t._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("time")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'使用 worker 主线程运行总时间'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" worker "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Worker")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./work.js'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'把衣服放进洗衣机'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  worker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("postMessage")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'开始洗衣服'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("time")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'做饭时间'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" index "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" index "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" index"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'我正在做饭'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("timeEnd")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'做饭时间'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n  worker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onmessage")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("event")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'主线层收到 worker 的消息：'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" event"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    worker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("terminate")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'关闭worker'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("timeEnd")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'使用 worker 主线程运行总时间'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("script"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("html"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),n("p",[t._v("work.js")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("addEventListener")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'message'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("event")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'worker收到消息：'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" event"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("time")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'webWorker 洗衣服时间'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" index "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" index "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" index"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'我正在洗衣服'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("timeEnd")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'webWorker 洗衣服时间'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'window对象：'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" window"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'document对象：'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" document"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'navigator对象：'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" navigator"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'location对象：'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" location"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("postMessage")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'衣服我洗完了'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("p",[t._v("从例子中可以看出，因为 Worker 线程所在的全局对象与主线程不一样，所以无法读取主线程所在网页的 DOM 对象，也就是无法使用 document、window、parent 这些对象（"),n("strong",[t._v("DOM 限制")]),t._v("）。但是，因为他们处在同一个进程下，所以 Worker 线程可以使用 navigator 对象和 location 对象。而因为 Worker 线程和主线程不在同一个上下文环境，所以它们不能直接通信，必须通过消息完成（"),n("strong",[t._v("通信联系")]),t._v("）")]),t._v(" "),n("p",[t._v("看到这里可能大家会想我用 setTimeOut 也可以实现这样的效果呀，其实它之所以可以实现这样的效果，其实是因为 JS 的 eventLoop，但是本质上他还是在一个线程中实现的这个效果。另外，除了这个专用的 Worker 之外，还有一些其他种类的 Worker，比如")]),t._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/SharedWorker",target:"_blank",rel:"noopener noreferrer"}},[t._v("Shared Worker"),n("OutboundLink")],1),t._v("：可被不同的窗体的多个脚本运行，例如 IFrames 等，只要这些 workers 处于同一主域。Shared Worker 比专用 worker 稍微复杂一点 — 脚本必须通过活动端口进行通讯。")]),t._v(" "),n("li",[n("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API",target:"_blank",rel:"noopener noreferrer"}},[t._v("Chrome Worker"),n("OutboundLink")],1),t._v("：仅适用于 firefox 的 worker。如果您正在开发附加组件，希望在扩展程序中使用 worker 且可以访问 js-ctypes，那么可以使用 Chrome Workers。")]),t._v(" "),n("li",[n("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API#audio_workers",target:"_blank",rel:"noopener noreferrer"}},[t._v("Video Worker"),n("OutboundLink")],1),t._v("：可以在网络 worker 上下文中直接完成脚本化音频处理。")]),t._v(" "),n("li",[n("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API",target:"_blank",rel:"noopener noreferrer"}},[t._v("Service Worker"),n("OutboundLink")],1),t._v("：一般作为 web 应用程序、浏览器和网络（如果可用）之间的代理服务。他们旨在（除开其他方面）创建有效的离线体验，拦截网络请求，以及根据网络是否可用采取合适的行动，更新驻留在服务器上的资源。他们还将允许访问推送通知和后台同步API。")])]),t._v(" "),n("p",[t._v("关于其他三种 Worker 的作用如果大家感兴趣的话可以自行搜索了解一下，今天我们重点讲一下 ServiceWorker。")]),t._v(" "),n("p",[t._v("既然 ServiceWorker 是 Web Worker 的一种的话，那我们就可以大概知道 ServiceWorker 应该也是创建了一个 worker 线程，然后做了某些事情。至于做了什么事情呢？我们待会来讲，现在我们先来说说 PWA。")]),t._v(" "),n("h2",{attrs:{id:"pwa（渐进式网页应用）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#pwa（渐进式网页应用）"}},[t._v("#")]),t._v(" PWA（渐进式网页应用）")]),t._v(" "),n("p",[t._v("PWA，全称是Progressive Web Apps，直译过来就是“渐进式网络应用程序”，那什么叫“渐进式网络应用程序”呢，Web App 我们都知道，主要是这个渐进式不太好理解，我觉得可以这样理解，比如有一个这样一个盒子，里面一边装了沙子，一遍装了水，两边互不影响，但是有一天这个隔板松动了，然后水就浸透了部分沙子，如果我们把水这边比喻成传统的 Web 应用，沙子这边比喻成原生应用 native APP 的话，本来他们俩也是进水不犯河水，各自有各自的特点，但是我们做 Web 应用的同学不安于现状（卷），做了个大胆的尝试，把原生应用的一些优点拿了过来，比如"),n("strong",[t._v("离线时也可以继续使用")]),t._v("；"),n("strong",[t._v("能够接收消息推送")]),t._v("； "),n("strong",[t._v("拥有像 app 一样的入口")]),t._v("；也就成为了我们所说的 PWA 了。")]),t._v(" "),n("p",[n("img",{attrs:{src:"https://tva1.sinaimg.cn/large/008i3skNly1gski0qa56bj318w0jm44b.jpg",alt:""}})]),t._v(" "),n("p",[t._v("另外说个题外话，有的同学可能还看过这样一张图片：")]),t._v(" "),n("p",[n("img",{attrs:{src:"https://tva1.sinaimg.cn/large/008i3skNly1gski4xsmmhj312q0jowfq.jpg",alt:""}})]),t._v(" "),n("p",[t._v("那么这里所说的 Hybird APP 又是什么呢？随着移动浪潮的兴起，各种 APP 层出不穷，极速的业务扩展提升了团队对开发效率的要求，这个时候使用 IOS&Andriod 开发一个 APP 似乎成本有点过高了，而 H5 的低成本、高效率、跨平台等特性马上被利用起来形成了一种新的开发模式：Hybrid APP。作为一种混合开发的模式，Hybrid APP 底层依赖于 Native 提供的容器（UIWebview），上层使用 Html&Css&JS 做业务开发，底层透明化、上层多多样化，这种场景非常有利于前端介入，非常适合业务快速迭代。比如近几年的小程序、快应用、React Native 等等。")]),t._v(" "),n("p",[t._v("回归正题，而如果想要实现一个 PWA 应用，最最重要的三个技术就是：")]),t._v(" "),n("ol",[n("li",[t._v("Manifest（能够将你浏览的网页添加到你的手机屏幕上）")]),t._v(" "),n("li",[t._v("Web Push（消息推送）")]),t._v(" "),n("li",[t._v("ServiceWorker（离线缓存文件)")])]),t._v(" "),n("p",[t._v("诶，你说巧不巧，我们又在这里碰到了我们今天的主角 ServiceWorker，说到这里大家应该都知道什么是 ServiceWorker，以及他可以能够做什么了吧。接下来我们就来看看怎么使用他吧。")]),t._v(" "),n("h2",{attrs:{id:"serviceworker-最佳实践-——-workbox"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#serviceworker-最佳实践-——-workbox"}},[t._v("#")]),t._v(" ServiceWorker 最佳实践 —— workbox")]),t._v(" "),n("p",[t._v("workbox 是 GoogleChrome 团队推出的一套 Web App 静态资源本地存储的解决方案，该解决方案包含一些 Js 库和构建工具，在 Chrome Submit 2017 上首次隆重面世。而在 workbox 背后则是 Service Worker 和 Cache API 等技术和标准在驱动。在 Workebox 之前，GoogleChrome 团队较早时间推出过 sw-precache 和 sw-toolbox 库，但是在 GoogleChrome 工程师们看来，workbox 才是真正能方便统一的处理离线能力的更完美的方案，所以停止了对 sw-precache 和 sw-toolbox 的维护。")]),t._v(" "),n("p",[t._v("这里我主要使用的 workbox 的 webpack 插件（"),n("strong",[t._v("workbox-webpack-plugin")]),t._v("）来帮助我快速的接入workbox。")]),t._v(" "),n("p",[t._v("workbox 的配置比较多，可以自行到"),n("a",{attrs:{href:"https://developers.google.com/web/tools/workbox/reference-docs/latest/module-workbox-webpack-plugin.GenerateSW#GenerateSW",target:"_blank",rel:"noopener noreferrer"}},[t._v("官网"),n("OutboundLink")],1),t._v("上查阅相关资料。")]),t._v(" "),n("p",[t._v("这里我们主要介绍一下 runtimeCaching 和 additionalManifestEntries 这两个配置，因为 workBox 的缓存分为 precache 和 runningCache, 打包之后的代码, 会自己加入到 precache中, 所以无需再运行时配置缓存资源，而我们需要根据自己的业务需求来做相关的配置。runtimeCaching 中的参数比较常规，重点说一下 handler 这个参数，他代表了匹配到的资源采用何种缓存方式，具体的缓存方式和区别如下：")]),t._v(" "),n("p",[n("img",{attrs:{src:"https://tva1.sinaimg.cn/large/008i3skNly1gsl6mh4ff3j31hs0qigpo.jpg",alt:""}})]),t._v(" "),n("p",[t._v("对缓存感兴趣的同学也可以参考下这篇文章："),n("a",{attrs:{href:"https://jakearchibald.com/2014/offline-cookbook/#cache-then-network",target:"_blank",rel:"noopener noreferrer"}},[t._v("The offline cookbook"),n("OutboundLink")],1)]),t._v(" "),n("p",[t._v("来看看我的配置（仅供参考）")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Inside of webpack.config.js:")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" WorkboxPlugin "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'workbox-webpack-plugin'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nmodule"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Other webpack config...")]),t._v("\n\n  plugins"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Other plugins...")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WorkboxPlugin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("GenerateSW")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      swDest"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'workboxServiceWorker.js'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 注意点1: 不写这个名字, 插件默认会生成 service-worker.js 这个文件,然后不知道WHO又生成了一次service-worker.js这个文件(内容不是workbox预期), 所以webpack生成的workbox的脚本就这样被替换了! 导致插件配置好的文件其实没被写出!!!")]),t._v("\n      clientsClaim"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 是否应该在激活后立即开始控制任何现有客户端。")]),t._v("\n      skipWaiting"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 是否向生成的服务工作者添加对 skipWaiting() 的无条件调用。如果为 false，则将添加消息侦听器，允许您通过发布包含 {type: 'SKIP_WAITING'} 的消息有条件地调用 skipWaiting()。")]),t._v("\n      cleanupOutdatedCaches"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Workbox 是否应该尝试识别和删除由旧的、不兼容的建的任何预缓存。")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// runtimeCaching: [{")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//   urlPattern: /app/,")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//   handler: 'NetworkFirst',")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//   options: {")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//     cacheName: 'cached-app',")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//     networkTimeoutSeconds: 2,")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//     expiration: {")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//       maxEntries: 50,")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//       maxAgeSeconds: 1 * 24 * 60 * 60 // 1 day")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//     },")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//     cacheableResponse: {")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//       statuses: [0, 200]")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//     }")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//   }")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// }],")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// additionalManifestEntries: [] // 要预渲染的列表")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// babelPresetEnvTargets: [''], // 转换 service worker 包时传babel-preset-env 的目标。")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// cacheId: '', // 附加到缓存名称的可选 ID。这主要用于本地开发，其中多个站点可以个 http://localhost:port 源提供服务。")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// chunks: [''] // 一个或多个块名称，其对应的输出文件应包含在预缓存清单中。")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// directoryIndex: '', // 如果对以 / 结尾的 URL 的导航请求与预缓存 URL 匹配失该值将附加到 URL 并检查预缓存匹配。这应该设置为您的 Web 服务器用于其目录索引的内容。")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// exclude: [], // 一个或多个用于从预缓存清单中排除资产的说明符。这按照与 webpack准排除选项相同的规则进行解释")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// excludeChunks: [], // 应从预缓存清单中排除其相应输出文件的一个或多个块名称。")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ignoreURLParametersMatching: [/.+/g, /./g], // 在查找预缓存匹配之前，将删数组中的正则表达式之一匹配的任何搜索参数名称。如果您的用户可能请求包含用于跟踪流量来URL 参数等 URL，这将非常有用。")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// importScripts: [''], // 应传递给生成的 Service Worker 文件中的 importScripts() 的 JavaScript 文件列表。当您想让 Workbox 创建您的顶级 Service Worker 文件，但想要包含一些额外的代码（例如推送事件侦听器）时，这很有用。")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// importScriptsViaChunks: [''], // webpack 块的一个或多个名称。这些块的内容调用 importScripts() 包含在生成的 service worker 中。")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// include: ['app.js'], // 一个或多个用于在预缓存清单中包含资产的说明符。这按webpack 的标准包含选项相同的规则进行解释。")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// inlineWorkboxRuntime: true, // Workbox 库的运行时代码是否应该包含在Service Worker 中，或者拆分为需要与 Service Worker 一起部署的单独文件。保持运行意味着用户不必在每次顶级 Service Worker 更改时重新下载 Workbox 代码。")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// manifestTransforms: [ // 将针对生成的清单顺序应用的一个或多个函数。如果还指modifyURLPrefix 或 dontCacheBustURLsMatching，则将首先应用它们相应的转换")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//   {")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//     manifestEntries: [ // 当前转换之前的完整条目数组")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//       {")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//         url: '',")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//         revision: '', // 这应该是基于文件内容生成的哈希，或者如果 URL 中已经包含版本控制，则为 null")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//         integrity: '' // 可选")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//       }")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//     ],")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//     compilation: {} // 可选： 在 webpack 插件中使用时，此参数将设置为当前编译。")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//   }")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ],")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// maximumFileSizeToCacheInBytes: 1024, // 用于确定将被预缓存的文件的最大大小以防止您无意中预缓存可能意外匹配您的模式之一的非常大的文件")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// mode: 'production', // 如果设置为“production”，则将生成排除调试信息的优化服线程包。如果这里没有明确配置，将使用当前 webpack 编译中配置的 mode 值。")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// navigateFallback: '', // 如果指定，则所有未预先缓存的 URL 的导航请求都将使的 URL 处的 HTML 来完成。您必须传入预缓存清单中列出的 HTML 文档的 URL。这旨在用于用程序场景，在该场景中，您希望所有导航都使用通用的 App Shell HTML。")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// navigateFallbackDenylist: [/.+/g, /./g], // 用于限制配置的 navigateFallba行为适用于哪些 URL。如果只应将站点 URL 的一个子集视为单页应用程序的一部分，这将非常如果同时配置了navigateFallbackDenylist 和navigateFallbackAllowlist，则拒绝先。")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// navigateFallbackAllowlist: [/.+/g], // 用于限制配置的 navigateFallback 行为适用于哪些 URL。如果只有您网站的一部分 URL 应该被视为单页应用程序的一部分，这将非常有用。如果同时配置了navigateFallbackDenylist 和navigateFallbackAllowlist，则拒绝列表优先。")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// navigationPreload: true, // 是否在生成的 Service Worker 中启用导航预加载。为 true 时，您还必须使用 runtimeCaching 设置匹配导航请求的适当响应策略，并利用预加应。")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// offlineGoogleAnalytics: true | {}, // 控制是否包含对离线 Google Analytic支持。如果为 true，对 workbox-google-analytics 的 initialize() 的调用将添加到的服务工作线程中。当设置为一个对象时，该对象将被传递给 initialize() 调用，允许您自为。")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// sourcemap: true, // 是否为生成的 Service Worker 文件创建源映射")]),t._v("\n          "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("p",[t._v("然后在项目的入口文件中注册 ServiceWorker")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'serviceWorker'")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" navigator"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  window"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("addEventListener")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'load'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 注意: 这里有个坑 workboxServiceWorker 会被缓存, 所以加个时间戳防止被缓存")]),t._v("\n    navigator"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("serviceWorker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("register")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token template-string"}},[n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("/workboxServiceWorker.js?")]),n("span",{pre:!0,attrs:{class:"token interpolation"}},[n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("Date"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("registration")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'SW registered: '")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" registration"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("catch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("registrationError")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'SW registration failed: '")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" registrationError"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("这样就配置完了，惊不惊喜意不意外。然后打开浏览器控制台，尝试把网断开，是不是网站依然还可以访问呀~")]),t._v(" "),n("p",[t._v("那我们来分析一下这个过程都发生了些什么")]),t._v(" "),n("p",[t._v("首次导航到网站时，会下载、解析并执行 Service Worker 文件，触发 install 事件，尝试安装 Service Worker，如果 install 事件回调函数中的操作都执行成功，标志 Service Worker 安装成功，此时进入 waiting状态，注意这时的 Service Worker 只是准备好了而已，并没有生效，当用户二次进入网站时，才会激活 Service Worker，此时会触发 activate 事件，标志 Service Worker 正式启动，开始响应 fetch、post、sync 等事件。如果之后重新注册 Service Worker，之前的将被替换，或者前面的 install 和 active 阶段失败都将重新尝试注册 Service Worker。这也就是 Service Worker 的生命周期。")]),t._v(" "),n("p",[n("img",{attrs:{src:"https://tva1.sinaimg.cn/large/008i3skNly1gskynmiw02j31a20ootc5.jpg",alt:""}})]),t._v(" "),n("h3",{attrs:{id:"service-worker-主要事件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#service-worker-主要事件"}},[t._v("#")]),t._v(" Service Worker 主要事件")]),t._v(" "),n("ul",[n("li",[n("strong",[t._v("install")]),t._v("：Service Worker 安装时触发，通常在这个时机缓存文件。")]),t._v(" "),n("li",[n("strong",[t._v("activate")]),t._v("：Service Worker 激活时触发，通常在这个时机做一些重置的操作，例如处理旧版本 Service - Worker 的缓存。")]),t._v(" "),n("li",[n("strong",[t._v("fetch")]),t._v("：浏览器发起 HTTP 请求时触发，通常在这个事件的回调函数中匹配缓存，是最常用的事件。")]),t._v(" "),n("li",[n("strong",[t._v("push")]),t._v("：和推送通知功能相关")]),t._v(" "),n("li",[n("strong",[t._v("sync")]),t._v("：和后台同步功能相关")])]),t._v(" "),n("h2",{attrs:{id:"最后"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#最后"}},[t._v("#")]),t._v(" 最后")]),t._v(" "),n("p",[t._v("ServiceWorker 的缓存带来的性能上的提升并不是一个从无到有的突破，因为浏览器本身有着相对完善的 HTTP 缓存机制，所以使用 ServiceWorker 缓存，并不能使我们已经相对完善的架构有立竿见影的性能提升，ServiceWorker 缓存真正有意义的地方在于，利用它可以更精准地、以编码方式控制缓存，如何缓存、缓存什么、如何更新缓存，完全取决于代码如何写，所以这提供了很大的自由度，但同时也带来维护成本。以及 ServiceWorker 是在千奇百怪的客户端做一些危险的操作，所以也比较容易出问题，但是依然不能否认 ServiceWorker 的强大，比如下面这些产品都应用到了这项技术。")]),t._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://web.dev/offline-fallback-page/",target:"_blank",rel:"noopener noreferrer"}},[t._v("web.dev"),n("OutboundLink")],1)]),t._v(" "),n("li",[n("a",{attrs:{href:"https://mswjs.io/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Mock Service Worker"),n("OutboundLink")],1)]),t._v(" "),n("li",[n("a",{attrs:{href:"https://theia-ide.org/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Theia"),n("OutboundLink")],1)])]),t._v(" "),n("p",[t._v("参考链接：")]),t._v(" "),n("p",[n("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API",target:"_blank",rel:"noopener noreferrer"}},[t._v("Web Workers API"),n("OutboundLink")],1),t._v(" "),n("a",{attrs:{href:"https://juejin.cn/post/6844903556470816781",target:"_blank",rel:"noopener noreferrer"}},[t._v("简单介绍一下Progressive Web App(PWA)"),n("OutboundLink")],1),t._v(" "),n("a",{attrs:{href:"https://juejin.cn/post/6844903887296528398#heading-3",target:"_blank",rel:"noopener noreferrer"}},[t._v("Service Worker 从入门到出门"),n("OutboundLink")],1),t._v(" "),n("a",{attrs:{href:"https://juejin.cn/post/6844903552335233031#heading-15",target:"_blank",rel:"noopener noreferrer"}},[t._v("神奇的 Workbox 3.0 - 让你的 Web 站点轻松做到离线可访问"),n("OutboundLink")],1)])])}),[],!1,null,null,null);s.default=e.exports}}]);